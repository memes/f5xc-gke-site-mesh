# Autogenerated by foundations Terraform
# spell-checker: disable
---
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - ../../../f5xc-site/upstream
  - Kptfile
  - resourcegroup.yaml

commonAnnotations: ${jsonencode(annotations)}
configMapGenerator:
  - name: vpm-cfg
    namespace: ves-system
    behavior: replace
    files:
      - config.yaml=vpm-config.yaml
# Apply labels to the metadata of all resources, but do not update selectors,
# etc.; commonLabels builtin will update the ver-nodeport-ver-N selectors which
# will then fail to match resources dynamically added by vp-manager during
# registration.
transformers:
  - |-
    apiVersion: builtin
    kind: LabelTransformer
    metadata:
      name: metadata-labeler
    labels: ${jsonencode(labels)}
    fieldSpecs:
      - path: metadata/labels
        create: true
%{ if coalesce(vip, "unspecified") != "unspecified" ~}
# Reconfigure ver-nodeport-ver-0/1/2 to use an L4 LB on the reserved public
# IP address.
patches:
  - target:
      group: ''
      version: v1
      kind: Service
      name: ver-nodeport-ver-.*
      namespace: ves-system
    patch: |-
      - op: remove
        path: /spec/ports/0/nodePort
      - op: replace
        path: /spec/type
        value: LoadBalancer
      - op: add
        path: /spec/loadBalancerIP
        value: ${vip}
  - target:
      group: ''
      version: v1
      kind: Service
      name: ver-nodeport-ver-0
      namespace: ves-system
    patch: |-
      - op: replace
        path: /spec/ports/0/port
        value: 30500
  - target:
      group: ''
      version: v1
      kind: Service
      name: ver-nodeport-ver-1
      namespace: ves-system
    patch: |-
      - op: replace
        path: /spec/ports/0/port
        value: 30501
  - target:
      group: ''
      version: v1
      kind: Service
      name: ver-nodeport-ver-2
      namespace: ves-system
    patch: |-
      - op: replace
        path: /spec/ports/0/port
        value: 30502
%{ endif ~}
